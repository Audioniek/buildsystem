--- enigma2-networkbrowser/src/MountView.py.org
+++ enigma2-networkbrowser/src/MountView.py
@@ -115,7 +115,7 @@
                 cur = self["config"].getCurrent()
                 if cur:
                         returnValue = cur[1]
-                        self.applyConfigRef = self.session.openWithCallback(self.applyConfigfinishedCB, MessageBox, _("Please wait while removing your network mount..."), type=MessageBox.TYPE_INFO, enable_input=False)
+                        self.applyConfigRef = self.session.openWithCallback(self.applyConfigfinishedCB, MessageBox, _("Please wait while removing your network mount..."), type = MessageBox.TYPE_INFO, timeout = 10)
                         iAutoMount.removeMount(returnValue, self.removeDataAvail)
 
         def removeDataAvail(self, data):
--- enigma2-networkbrowser/src/NetworkBrowser.py.org
+++ enigma2-networkbrowser/src/NetworkBrowser.py
@@ -134,7 +134,6 @@
 
 	def cleanup(self):
 		del self.Timer
-		iAutoMount.stopMountConsole()
 		iNetwork.stopRestartConsole()
 		iNetwork.stopGetInterfacesConsole()
 
--- enigma2-networkbrowser/src/plugin.py.org
+++ enigma2-networkbrowser/src/plugin.py
@@ -32,24 +32,10 @@
 	return MountManagerMain
 
 
-def RemountMain(session, iface=None, **kwargs):
-	from AutoMount import iAutoMount
-	iAutoMount.getAutoMountPoints()
-
-
-def RemountCallFunction(iface):
-	if iNetwork.getAdapterAttribute(iface, "up"):
-		return RemountMain
-
-
 def Plugins(path, **kwargs):
 	global plugin_path
 	plugin_path = path
 	return [
 		PluginDescriptor(name=_("NetworkBrowser"), description=_("Search for network shares") + "\n", where=PluginDescriptor.WHERE_NETWORKSETUP, fnc={"ifaceSupported": NetworkBrowserCallFunction, "menuEntryName": lambda x: _("NetworkBrowser"), "menuEntryDescription": lambda x: _("Search for network shares...") + "\n"}),
 		PluginDescriptor(name=_("MountManager"), description=_("Manage network shares") + "\n", where=PluginDescriptor.WHERE_NETWORKSETUP, fnc={"ifaceSupported": MountManagerCallFunction, "menuEntryName": lambda x: _("MountManager"), "menuEntryDescription": lambda x: _("Manage your network shares...") + "\n"}),
-		PluginDescriptor(name=_("Mount again"), description=_("Attempt to mount shares again") + "\n", where=PluginDescriptor.WHERE_NETWORKSETUP,
-			fnc={"ifaceSupported": RemountCallFunction,
-				"menuEntryName": lambda x: _("Mount again"),
-				"menuEntryDescription": lambda x: _("Attempt to recover lost mounts (in background)") + "\n"})
 	]
--- enigma2-networkbrowser/src/AutoMount.py.org
+++ enigma2-networkbrowser/src/AutoMount.py
@@ -2,16 +2,19 @@
 # for localized messages
 from __init__ import _
 import os
+import re
+import subprocess
+import shlex
 from enigma import eTimer
 from Components.Console import Console
 from Components.Harddisk import harddiskmanager #global harddiskmanager
-from xml.etree.cElementTree import parse as cet_parse
-
-XML_FSTAB = "/etc/enigma2/automounts.xml"
+
+XML_FSTAB = "/etc/auto.network"
+
 
 def rm_rf(d): # only for removing the ipkg stuff from /media/hdd subdirs
 	try:
-		for path in (os.path.join(d,f) for f in os.listdir(d)):
+		for path in (os.path.join(d, f) for f in os.listdir(d)):
 			if os.path.isdir(path):
 				rm_rf(path)
 			else:
@@ -24,18 +27,15 @@
 	"""Manages Mounts declared in a XML-Document."""
 	def __init__(self):
 		self.automounts = {}
-		self.restartConsole = Console()
 		self.MountConsole = Console()
-		self.removeConsole = Console()
 		self.activeMountsCounter = 0
 		# Initialize Timer
 		self.callback = None
 		self.timer = eTimer()
-		self.timer.callback.append(self.mountTimeout)
 
 		self.getAutoMountPoints()
 
-	def getAutoMountPoints(self, callback = None):
+	def getAutoMountPoints(self, callback=None):
 		# Initialize mounts to empty list
 		automounts = []
 		self.automounts = {}
@@ -43,149 +43,203 @@
 
 		if not os.path.exists(XML_FSTAB):
 			return
-		tree = cet_parse(XML_FSTAB).getroot()
+
+		try:
+			tree = open(XML_FSTAB, "r").read()
+		except Exception, e:
+			print "[MountManager] Error reading /etc/enigma2/automounts.xml:", e
+			try:
+				os.remove(XML_FSTAB)
+			except Exception, e:
+				print "[MountManager] Error delete corrupt /etc/enigma2/automounts.xml:", e
+			return
 
 		def getValue(definitions, default):
 			# Initialize Output
 			ret = ""
 			# How many definitions are present
 			Len = len(definitions)
-			return Len > 0 and definitions[Len-1].text or default
-		# Config is stored in "mountmanager" element
-		# Read out NFS Mounts
-		for nfs in tree.findall("nfs"):
-			for mount in nfs.findall("mount"):
-				data = { 'isMounted': False, 'active': False, 'ip': False, 'sharename': False, 'sharedir': False, 'username': False, \
-							'password': False, 'mounttype' : False, 'options' : False, 'hdd_replacement' : False }
+			return Len > 0 and definitions[Len - 1].text or default
+
+		for line in tree.split("\n"):
+			line = re.sub(' +','\t',line)
+			print "LINE", line
+			# Read out NFS Mounts
+			if "-fstype=nfs" in line or "-fstype=cifs" in line:
+				data = {'isMounted': False, 'active': False, 'ip': False, 'host': False, 'sharename': False, 'sharedir': False, 'username': False,
+							'password': False, 'mounttype': False, 'options': False, 'hdd_replacement': False}
 				try:
-					data['mounttype'] = 'nfs'.encode("UTF-8")
-					data['active'] = getValue(mount.findall("active"), False).encode("UTF-8")
-					if data["active"] == 'True' or data["active"] == True:
-						self.activeMountsCounter +=1
+					if "-fstype=nfs" in line:
+						data['mounttype'] = 'nfs'.encode("UTF-8")
+					elif "-fstype=cifs" in line:
+						data['mounttype'] = 'cifs'.encode("UTF-8")
+					if line[0] == "#":
+						line = line[1:]
+						data['active'] = 'False'.encode("UTF-8")
+					else:
+						data['active'] = 'True'.encode("UTF-8")
+
+					if data["active"] == 'True':
+						self.activeMountsCounter += 1
 					data['hdd_replacement'] = getValue(mount.findall("hdd_replacement"), "False").encode("UTF-8")
-					data['ip'] = getValue(mount.findall("ip"), "192.168.0.0").encode("UTF-8")
-					data['sharedir'] = getValue(mount.findall("sharedir"), "/media/").encode("UTF-8")
-					data['sharename'] = getValue(mount.findall("sharename"), "MEDIA").encode("UTF-8")
-					data['options'] = getValue(mount.findall("options"), "rw,nolock,tcp").encode("UTF-8")
+					fields = line.split("\t")
+					data['sharename'] = fields[0].encode("UTF-8")
+
+					data['username'] = 'guest'.encode("UTF-8")
+					data['password'] = ''.encode("UTF-8")
+					data['options'] = ""
+					for option in fields[1].split(","):
+						if option.startswith("-fstype"):
+							continue
+						elif option.startswith("user"):
+							data['username'] = option[5:].encode("UTF-8")
+						elif option.startswith("pass"):
+							data['password'] = option[5:].encode("UTF-8")
+						else:
+							data['options'] += option + ","
+					if len(data['options']) > 1:
+						data['options'] = data['options'][:-1]
+					data['options'] = data['options'].encode("UTF-8")
+
+					if fields[2][:3] == "://": #cifs
+						ip = fields[2][3:].split("/", 1)
+					else:
+						ip = fields[2].split(":/", 1)
+					data['ip'] = ip[0].encode("UTF-8")
+					data['sharedir'] = ip[1].encode("UTF-8")
+					if len(fields) > 3 and fields[3][1:] == "HDD_REPLACEMENT":
+						data['hdd_replacement'] = 'True'.encode("UTF-8")
+					else:
+						data['hdd_replacement'] = 'False'.encode("UTF-8")
 					self.automounts[data['sharename']] = data
 				except Exception, e:
 					print "[MountManager] Error reading Mounts:", e
-			# Read out CIFS Mounts
-		for nfs in tree.findall("cifs"):
-			for mount in nfs.findall("mount"):
-				data = { 'isMounted': False, 'active': False, 'ip': False, 'sharename': False, 'sharedir': False, 'username': False, \
-							'password': False, 'mounttype' : False, 'options' : False, 'hdd_replacement' : False }
+
+		# Read out CIFS Mounts
+		for nfs in re.findall("cifs", tree):
+			for mount in re.findall("mount", nfs):
+				data = {'isMounted': False, 'active': False, 'ip': False, 'host': False, 'sharename': False, 'sharedir': False, 'username': False,
+							'password': False, 'mounttype': False, 'options': False, 'hdd_replacement': False}
 				try:
 					data['mounttype'] = 'cifs'.encode("UTF-8")
 					data['active'] = getValue(mount.findall("active"), False).encode("UTF-8")
 					if data["active"] == 'True' or data["active"] == True:
 						self.activeMountsCounter +=1
-					data['hdd_replacement'] = getValue(mount.findall("hdd_replacement"), "False").encode("UTF-8")
-					data['ip'] = getValue(mount.findall("ip"), "192.168.0.0").encode("UTF-8")
-					data['sharedir'] = getValue(mount.findall("sharedir"), "/media/").encode("UTF-8")
-					data['sharename'] = getValue(mount.findall("sharename"), "MEDIA").encode("UTF-8")
-					data['options'] = getValue(mount.findall("options"), "rw,nolock").encode("UTF-8")
-					data['username'] = getValue(mount.findall("username"), "guest").encode("UTF-8")
-					data['password'] = getValue(mount.findall("password"), "").encode("UTF-8")
+					data['hdd_replacement'] = getValue(re.findall("hdd_replacement", mount), 'False').encode("UTF-8")
+					data['ip'] = getValue(re.findall("ip", mount), '').encode("UTF-8")
+					data['host'] = getValue(re.findall("host", mount), '').encode("UTF-8")
+					data['sharedir'] = getValue(re.findall("sharedir", mount), '/media/').encode("UTF-8")
+					data['sharename'] = getValue(re.findall("sharename", mount), 'MEDIA').encode("UTF-8")
+					data['options'] = getValue(re.findall("options", mount), "").encode("UTF-8")
+					data['username'] = getValue(re.findall("username", mount), '').encode("UTF-8")
+					data['password'] = getValue(re.findall("password", mount), '').encode("UTF-8")
 					self.automounts[data['sharename']] = data
 				except Exception, e:
 					print "[MountManager] Error reading Mounts:", e
 
 		self.checkList = self.automounts.keys()
 		if not self.checkList:
-			print "[AutoMount.py] self.automounts without mounts",self.automounts
+			print "[AutoMount.py] self.automounts without mounts", self.automounts
 			if callback is not None:
 				callback(True)
 		else:
 			self.CheckMountPoint(self.checkList.pop(), callback)
 
-	def sanitizeOptions(self, origOptions, cifs=False):
-		options = origOptions.strip()
-		if not options:
-			options = 'rsize=8192,wsize=8192'
-			if not cifs:
-				options += ',tcp'
+	def sanitizeOptions(self, origOptions, mounttype=None, username=None, password=None):
+		# split the options into their components
+		lexer = shlex.shlex(origOptions, posix=True)
+		lexer.whitespace_split = True
+		lexer.whitespace = ','
+		options = list(map(str.strip, list(lexer)))
+
+		# if not specified, mount read/write
+		if 'ro' not in options and 'rw' not in options:
+			options.append('rw')
+
+		# cifs specific options
+
+		if mounttype == "cifs":
+			# remove any hardcoded username and passwords
+			options = [i for i in options if not i.startswith('user=')]
+			options = [i for i in options if not i.startswith('username=')]
+			options = [i for i in options if not i.startswith('pass=')]
+			options = [i for i in options if not i.startswith('password=')]
+
+			# and add any passed
+			if username or password:
+				options.append('username="%s"' % username)
+				options.append('password="%s"' % ("" if password is None else password))
+
+			# default to utf8
+			if not [i for i in options if i.startswith('iocharset=')]:
+				options.append('iocharset=utf8')
+
+		# nfs specific options
+
+		elif mounttype == "nfs":
+
+			# if not specified, disable locking
+			if 'lock' not in options and 'nolock' not in options:
+				options.append('nolock')
+
+			# if no protocol given, default to udp
+			if 'tcp' not in options and 'udp' not in options and 'proto=tcp' not in options and 'proto=udp' not in options:
+				options.append('proto=tcp')
+
+			# by default do not retry
+			if not [i for i in options if i.startswith('retry=')]:
+				options.append('retry=0')
+
+			# if not specified, allow file service interruptions
+			if 'intr' not in options and 'nointr' not in options:
+				options.append('intr')
+
+			# if not specified, don't hang on server errors
+			if 'soft' not in options and 'hard' not in options:
+				options.append('soft')
+
+			# if not specified, don't update last access time
+			if 'atime' not in options and 'noatime' not in options and 'relatime' not in options:
+				options.append('noatime')
+
+		# unknown mounttype
 		else:
-			if 'rsize' not in options:
-				options += ',rsize=8192'
-			if 'wsize' not in options:
-				options += ',wsize=8192'
-			if not cifs and 'tcp' not in options and 'udp' not in options:
-				options += ',tcp'
-		return options
+			print "[AutoMount.py] Unknown mount type: ", mounttype
+
+		# return the sanitized options list
+		return ",".join(options)
 
 	def CheckMountPoint(self, item, callback):
-		data = self.automounts[item]
-		if not self.MountConsole:
-			self.MountConsole = Console()
-		command = None
+		self.CheckMountPointFinished(command, ret, [data, callback])
+
+		# execute any command constructed
+#		if command:
+#			self.MountConsole.ePopen(command, self.CheckMountPointFinished, [data, callback])
+#		else:
+#			self.CheckMountPointFinished(None, None, [data, callback])
+
+	def CheckMountPointFinished(self, result, retval, extra_args):
+		print "[AutoMount.py] CheckMountPointFinished", result, retval
+		(data, callback) = extra_args
 		path = os.path.join('/media/net', data['sharename'])
-		if self.activeMountsCounter == 0:
-			print "self.automounts without active mounts",self.automounts
-			if data['active'] == 'False' or data['active'] is False:
-				umountcmd = "umount -fl '%s'" % path
-				print "[AutoMount.py] UMOUNT-CMD--->",umountcmd
-				self.MountConsole.ePopen(umountcmd, self.CheckMountPointFinished, [data, callback])
-		else:
-			if data['active'] == 'False' or data['active'] is False:
-				command = "umount -fl '%s'" % path
-
-			elif data['active'] == 'True' or data['active'] is True:
-			        try:
-					if not os.path.exists(path):
-						os.makedirs(path)
-					if data['mounttype'] == 'nfs':
-						if not os.path.ismount(path):
-							if data['options']:
-								options = "tcp,noatime," + data['options']
-							else:
-								options = "tcp,noatime"
-							tmpcmd = "mount -t nfs -o %s '%s' '%s'" % (options, data['ip'] + ':/' + data['sharedir'], path)
-							command = tmpcmd.encode("UTF-8")
-
-					elif data['mounttype'] == 'cifs':
-						if not os.path.ismount(path):
-							tmpusername = data['username'].replace(" ", "\\ ")
-							options = data['options'] + ',noatime,noserverino,iocharset=utf8,username='+ tmpusername + ',password='+ data['password']
-							tmpcmd = "mount -t cifs -o %s '//%s/%s' '%s'" % (options, data['ip'], data['sharedir'], path)
-							command = tmpcmd.encode("UTF-8")
-				except Exception, ex:
-				        print "[AutoMount.py] Failed to create", path, "Error:", ex
-					command = None
-			if command:
-				print "[AutoMount.py] U/MOUNTCMD--->",command
-				self.MountConsole.ePopen(command, self.CheckMountPointFinished, [data, callback])
-			else:
-				self.CheckMountPointFinished(None,None, [data, callback])
-
-	def CheckMountPointFinished(self, result, retval, extra_args):
-		print "[AutoMount.py] CheckMountPointFinished",result,retval
-		(data, callback ) = extra_args
-		path = os.path.join('/media/net', data['sharename'])
-		if os.path.exists(path):
-			if os.path.ismount(path):
-				if self.automounts.has_key(data['sharename']):
-					self.automounts[data['sharename']]['isMounted'] = True
-					desc = data['sharename']
-					if self.automounts[data['sharename']]['hdd_replacement'] == 'True': #hdd replacement hack
-						self.makeHDDlink(path)
-					harddiskmanager.addMountedPartition(path, desc)
-			else:
-				if self.automounts.has_key(data['sharename']):
-					self.automounts[data['sharename']]['isMounted'] = False
-				if os.path.exists(path):
-					if not os.path.ismount(path):
-					        try:
-							os.rmdir(path)
-							harddiskmanager.removeMountedPartition(path)
-						except Exception, ex:
-						        print "Failed to remove", path, "Error:", ex
+		print "[AutoMount.py] CheckMountPointFinished, verifying: ", path
+
+		if self.automounts.has_key(data['sharename']):
+			self.automounts[data['sharename']]['isMounted'] = True
+			desc = data['sharename']
+			if self.automounts[data['sharename']]['hdd_replacement'] == 'True':  #hdd replacement hack
+				self.makeHDDlink(path)
+			harddiskmanager.addMountedPartition(path, desc)
+
 		if self.checkList:
 			# Go to next item in list...
 			self.CheckMountPoint(self.checkList.pop(), callback)
+
 		if self.MountConsole:
+			print "[AutoMount.py] CheckMountPointFinished, # of appContainers: ", len(self.MountConsole.appContainers)
 			if len(self.MountConsole.appContainers) == 0:
 				if callback is not None:
+					print "[AutoMount.py] CheckMountPointFinished, callback timer"
 					self.callback = callback
 					self.timer.startLongTimer(1)
 
@@ -214,7 +268,7 @@
 		self.timer.stop()
 		if self.MountConsole:
 			if len(self.MountConsole.appContainers) == 0:
-				print "self.automounts after mounting",self.automounts
+				print "self.automounts after mounting", self.automounts
 				if self.callback is not None:
 					self.callback(True)
 
@@ -222,38 +276,42 @@
 		return self.automounts
 
 	def getMountsAttribute(self, mountpoint, attribute):
-		if self.automounts.has_key(mountpoint):
-			if self.automounts[mountpoint].has_key(attribute):
+		if mountpoint in self.automounts:
+			if attribute in self.automounts[mountpoint]:
 				return self.automounts[mountpoint][attribute]
 		return None
 
 	def setMountsAttribute(self, mountpoint, attribute, value):
-		if self.automounts.has_key(mountpoint):
+		if mountpoint in self.automounts:
 			self.automounts[mountpoint][attribute] = value
 
 	def writeMountsConfig(self):
 		# Generate List in RAM
-		list = ['<?xml version="1.0" ?>\n<mountmanager>\n']
+		list = ['# automatically generated by enigma 2\n']
 		for sharename, sharedata in self.automounts.items():
-			mtype = sharedata['mounttype']
-			list.append('<' + mtype + '>\n')
-			list.append(' <mount>\n')
-			list.append("  <active>" + str(sharedata['active']) + "</active>\n")
-			list.append("  <hdd_replacement>" + str(sharedata['hdd_replacement']) + "</hdd_replacement>\n")
-			list.append("  <ip>" + sharedata['ip'] + "</ip>\n")
-			list.append("  <sharename>" + sharedata['sharename'] + "</sharename>\n")
-			list.append("  <sharedir>" + sharedata['sharedir'] + "</sharedir>\n")
-			list.append("  <options>" + sharedata['options'] + "</options>\n")
+			print "SHARE", sharedata
+			if sharedata['active'] is False:
+				list.append('#')
+			list.append(sharedata['sharename'])
+			list.append('\t')
+			list.append('-fstype=' + sharedata['mounttype'])
+			list.append("," + sharedata['options'])
 
 			if sharedata['mounttype'] == 'cifs':
-				list.append("  <username>" + sharedata['username'] + "</username>\n")
-				list.append("  <password>" + sharedata['password'] + "</password>\n")
-
-			list.append(' </mount>\n')
-			list.append('</' + mtype + '>\n')
-
-		# Close Mountmanager Tag
-		list.append('</mountmanager>\n')
+				list.append(",user=" + sharedata['username'])
+				list.append(",pass=" + sharedata['password'])
+			list.append('\t')
+			if sharedata['mounttype'] == 'cifs':
+				list.append("://")
+			list.append(sharedata['ip'])
+			if sharedata['mounttype'] == 'nfs':
+				list.append(":/")
+			elif sharedata['mounttype'] == 'cifs':
+				list.append("/")
+			list.append(sharedata['sharedir'])
+			if sharedata['hdd_replacement'] is True:
+				list.append('\t#HDD_REPLACEMENT')
+			list.append('\n')
 
 		# Try Saving to Flash
 		try:
@@ -261,40 +319,13 @@
 		except Exception, e:
 			print "[AutoMount.py] Error Saving Mounts List:", e
 
-	def stopMountConsole(self):
-		if self.MountConsole is not None:
-			self.MountConsole = None
-
-	def removeMount(self, mountpoint, callback = None):
-		print "[AutoMount.py] removing mount: ",mountpoint
+	def removeMount(self, mountpoint, callback=None):
+		print "[AutoMount.py] removing mount: ", mountpoint
 		self.newautomounts = {}
 		for sharename, sharedata in self.automounts.items():
 			if sharename is not mountpoint.strip():
 				self.newautomounts[sharename] = sharedata
 		self.automounts.clear()
 		self.automounts = self.newautomounts
-		if not self.removeConsole:
-			self.removeConsole = Console()
-		path = '/media/net/'+ mountpoint
-		umountcmd = "umount -fl '%s'" % path
-		print "[AutoMount.py] UMOUNT-CMD--->",umountcmd
-		self.removeConsole.ePopen(umountcmd, self.removeMountPointFinished, [path, callback])
-
-	def removeMountPointFinished(self, result, retval, extra_args):
-		print "[AutoMount.py] removeMountPointFinished result", result, "retval", retval
-		(path, callback ) = extra_args
-		if os.path.exists(path):
-			if not os.path.ismount(path):
-			        try:
-					os.rmdir(path)
-					harddiskmanager.removeMountedPartition(path)
-				except Exception, ex:
-				        print "Failed to remove", path, "Error:", ex
-		if self.removeConsole:
-			if len(self.removeConsole.appContainers) == 0:
-				if callback is not None:
-					self.callback = callback
-					self.timer.startLongTimer(1)
-
 
 iAutoMount = AutoMount()

